from bake import *
from bake.util import get_package_data

from lattice.tasks.component import ComponentTask

class BuildDeb(ComponentTask):
    name = 'lattice.deb.build'
    description = 'builds a deb file of a built component'
    parameters = {
        'distpath': Path(nonempty=True),
    }

    def run(self, runtime):
        component = self.component
        self.buildroot = runtime.curdir
        self.tgzname = '%s-%s.tar.bz2' % (component['name'], component['version'])
        self.pkgname = '%s-%s.deb' % (component['name'], component['version'])

        self.workpath = runtime.curdir / 'build_deb'
        self.workpath.makedirs_p()

        controldir = self.workpath / 'DEBIAN'
        controldir.mkdir_p()

        template = get_package_data('lattice', 'templates/deb-control-file.tmpl')
        controlfile = template % {
            'component_name': component['name'],
            'component_version': component['version'],
            'component_maintainer_name': 'SIQ',
            'component_maintainer_email': 'acolichia@storediq.com',
            'component_depends': '',
            'component_description': 'Package generated by lattice.deb.build'}
        
        path('%s/control' % str(controldir)).write_bytes(controlfile)

        if 'pre-install' in self.build:
            script = path(self.build['pre-install'])
            if script.exists():
                script.copyfile(str(controldir / 'preinst'))
        
        if 'post-install' in self.build:
            script = path(self.build['post-install'])
            if script.exists():
                script.copyfile(str(controldir / 'postinst'))

        curdir = runtime.chdir(self.workpath)
        self._run_tar(runtime)

        runtime.chdir(curdir)
        self._run_dpkg(runtime)

    def _run_tar(self, runtime):
        shellargs = ['tar', '-xvjf', str(self['distpath'] / self.tgzname)]
        runtime.shell(shellargs, merge_output=True)

    def _run_dpkg(self, runtime):
        shellargs = ['dpkg', '-b', str(self.workpath), str(self['distpath'] / self.pkgname)]
        runtime.shell(shellargs, merge_output=True)
